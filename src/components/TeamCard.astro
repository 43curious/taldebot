---
import { db } from "../lib/db";
import { students, responses } from "../../db/schema";
import { inArray } from "drizzle-orm";

interface Props {
    teamNumber: number;
    memberIds: number[];
    justification: string;
}

const { teamNumber, memberIds, justification } = Astro.props;

const memberData = await db.query.students.findMany({
    where: inArray(students.id, memberIds),
});

const memberResponses = await db.query.responses.findMany({
    where: inArray(responses.studentId, memberIds),
});

const membersWithSkills = memberData.map((m) => {
    const resp = memberResponses.find((r) => r.studentId === m.id);
    if (!resp) return { ...m, topSkills: [] };

    const allSkills = [
        ...Object.entries(resp.skillsNarrative).map(([k, v]) => ({
            name: k,
            val: v,
            cat: "Narratiba",
        })),
        ...Object.entries(resp.skillsTechnical).map(([k, v]) => ({
            name: k,
            val: v,
            cat: "Teknika",
        })),
        ...Object.entries(resp.skillsManagement).map(([k, v]) => ({
            name: k,
            val: v,
            cat: "Kudeaketa",
        })),
    ];

    const topSkills = allSkills.sort((a, b) => b.val - a.val).slice(0, 3);
    return { ...m, topSkills };
});
---

<div
    class="bg-white shadow-lg shadow-slate-200/50 rounded-2xl border border-slate-200/60 overflow-hidden flex flex-col h-full"
>
    <div
        class="px-6 py-4 bg-slate-50 border-b border-slate-200/60 flex justify-between items-center"
    >
        <h3 class="text-lg font-bold text-slate-900">Taldea {teamNumber}</h3>
        <span
            class="text-[10px] bg-teal-100 text-teal-800 px-2.5 py-1 rounded-full font-bold uppercase tracking-wider"
            >{memberIds.length} Kide</span
        >
    </div>

    <div class="p-6 flex-grow">
        <ul class="space-y-4 mb-6">
            {
                membersWithSkills.map((member) => (
                    <li class="flex flex-col">
                        <span class="text-sm font-bold text-slate-800">
                            {member.name}
                        </span>
                        <div class="flex flex-wrap gap-1 mt-1.5">
                            {member.topSkills.map((skill) => (
                                <span
                                    class={`text-[9px] font-bold uppercase tracking-tight px-1.5 py-0.5 rounded border ${
                                        skill.cat === "Narratiba"
                                            ? "bg-orange-50 border-orange-100 text-orange-700"
                                            : skill.cat === "Teknika"
                                              ? "bg-teal-50 border-teal-100 text-teal-700"
                                              : "bg-green-50 border-green-100 text-green-700"
                                    }`}
                                >
                                    {skill.name} ({skill.val})
                                </span>
                            ))}
                        </div>
                    </li>
                ))
            }
        </ul>

        <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
            <h4
                class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.1em] mb-2"
            >
                Algoritmoaren Azalpena
            </h4>
            <p
                class="text-xs text-slate-500 leading-relaxed whitespace-pre-line line-clamp-4 hover:line-clamp-none transition-all cursor-default"
            >
                {justification}
            </p>
        </div>
    </div>

    <div class="px-6 py-4 bg-slate-50 border-t border-slate-200/60 mt-auto">
        <button
            class="text-xs text-teal-600 font-bold uppercase tracking-widest hover:text-teal-700 flex items-center justify-center w-full gap-2 transition-all p-2 hover:bg-teal-50 rounded-lg active:scale-95"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width={2.5}
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
            </svg>
            Taldea Editatu
        </button>
    </div>
</div>
