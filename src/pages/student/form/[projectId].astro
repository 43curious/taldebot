---
export const prerender = false;
import Layout from "../../../layouts/Layout.astro";
import { db } from "../../../lib/db";
import { projects, students } from "../../../../db/schema";
import { eq } from "drizzle-orm";
import { SkillSlider } from "../../../components/SkillSlider";
import { GroupDynamics } from "../../../components/GroupDynamics";

const { projectId } = Astro.params;

if (!projectId) {
    return Astro.redirect("/");
}

const project = await db.query.projects.findFirst({
    where: eq(projects.accessCode, projectId),
});

if (!project) {
    return Astro.redirect("/?error=not_found");
}

const url = new URL(Astro.request.url);
const initialStudentId = url.searchParams.get("studentId");

const pid = project.id;

const allStudents = await db.query.students.findMany({
    where: eq(students.projectId, pid),
    orderBy: (students, { asc }) => [asc(students.name)],
});

const activeStudents = allStudents.filter((s) => !s.isExcluded);
---

<Layout title={`Form: ${project.name}`}>
    <main class="max-w-3xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-teal-600 px-8 py-10 text-white">
                <div class="flex items-center gap-2 justify-between">
                    <p class="px-2 text-3xl font-bold">
                        {project.name}
                    </p>
                    <h1 class="text-teal-500 text-3xl font-bold mb-2">
                        TaldeBOT
                    </h1>
                </div>
            </div>

            <!-- Form -->
            <form
                id="student-form"
                action="/api/student/submit-form"
                method="POST"
                class="p-8 pt-2 space-y-8"
            >
                <input type="hidden" name="projectId" value={pid} />

                <!-- Progress Indicator (Controlled by JS) -->
                <div class="flex items-center gap-2 mb-4" id="progress-bar">
                    <div
                        class="h-1 flex-1 bg-teal-600 rounded-full transition-all duration-300"
                        style="width: 25%"
                    >
                    </div>
                    <div
                        class="h-1 flex-1 bg-slate-200 rounded-full transition-all duration-300"
                    >
                    </div>
                    <div
                        class="h-1 flex-1 bg-slate-200 rounded-full transition-all duration-300"
                    >
                    </div>
                    <div
                        class="h-1 flex-1 bg-slate-200 rounded-full transition-all duration-300"
                    >
                    </div>
                </div>

                <!-- Section 1: Identification -->
                <section id="section-1" class="section-active">
                    <h2
                        class="text-xl font-semibold mb-6 flex items-center gap-2"
                    >
                        <span
                            class="w-8 h-8 rounded-full bg-teal-600 text-white flex items-center justify-center text-sm"
                            >1</span
                        >
                        Nor zara?
                    </h2>
                    <p
                        id="section-description-1"
                        class="bg-teal-50/80 border border-teal-200/60 p-5 rounded-xl text-teal-700 text-sm mb-6 leading-relaxed whitespace-pre-line transition-opacity duration-300"
                    >
                    </p>
                    <div class="space-y-6">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Hautatu zure izena</label
                            >
                            <select
                                name="studentId"
                                id="studentSelect"
                                required
                                class="w-full border border-slate-300 rounded-md bg-white px-3 py-2 shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                            >
                                <option value="">Aukeratu zerrendatik...</option
                                >
                                {
                                    activeStudents.map((s) => (
                                        <option
                                            value={s.id}
                                            disabled={s.hasCompleted}
                                            selected={
                                                initialStudentId ===
                                                String(s.id)
                                            }
                                        >
                                            {s.name}{" "}
                                            {s.hasCompleted
                                                ? "(Dagoeneko osatuta)"
                                                : ""}
                                        </option>
                                    ))
                                }
                            </select>
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Email akademikoa</label
                            >
                            <div class="flex rounded-md shadow-sm">
                                <input
                                    type="text"
                                    name="emailPrefix"
                                    id="emailPrefix"
                                    required
                                    placeholder="zure.izena"
                                    class="flex-1 border border-r-0 border-slate-300 rounded-l-md px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                />
                                <span
                                    class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm"
                                >
                                    @alumni.mondragon.edu
                                </span>
                            </div>
                            <input type="hidden" name="email" id="fullEmail" />
                        </div>

                        <div
                            class="bg-slate-50/50 p-4 rounded-lg border border-slate-100"
                        >
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input
                                        id="terms"
                                        name="terms"
                                        type="checkbox"
                                        required
                                        class="focus:ring-teal-500 h-4 w-4 text-teal-600 border-slate-300 rounded cursor-pointer"
                                    />
                                </div>
                                <div class="ml-3 text-sm">
                                    <label
                                        for="terms"
                                        class="font-medium text-slate-700 cursor-pointer"
                                    >
                                        <button
                                            type="button"
                                            id="openDisclaimer"
                                            class="text-teal-600 hover:underline"
                                            >Baldintzak</button
                                        > onartzen ditut
                                    </label>
                                    <p class="text-slate-500">
                                        Nire datu akademikoak taldeak osatzeko
                                        erabiltzea onartzen dut.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Disclaimer Modal -->
                    <div id="disclaimerModal" class="fixed inset-0 z-50 hidden">
                        <div
                            class="absolute inset-0 bg-black/50 backdrop-blur-sm"
                        >
                        </div>
                        <div
                            class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-lg md:mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-8"
                        >
                            <h3 class="text-xl font-bold text-gray-900 mb-4">
                                Datuen Erabilera
                            </h3>
                            <div
                                class="prose prose-sm text-gray-600 mb-6 font-medium"
                            >
                                <p>
                                    Inkesta honetan jasotako datuak proiektu
                                    honetan talde orekatuak osatzeko soilik
                                    erabiliko dira.
                                </p>
                                <p>
                                    <strong>Zer gorde dugu?</strong> Zure gaitasun
                                    autoebaluatuak, zure kideen hobespenak eta zure
                                    posta elektroniko akademikoa.
                                </p>
                                <p>
                                    Ez dira erakundetik kanpoko hirugarrenekin
                                    partekatuko eta taldeak esleitzeko prozesua
                                    amaitutakoan ezabatu edo anonimizatu egingo
                                    dira.
                                </p>
                            </div>
                            <button
                                type="button"
                                id="closeDisclaimer"
                                class="w-full py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 transition-colors uppercase tracking-widest text-xs"
                            >
                                Ados
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button
                            type="button"
                            id="btn-next-1"
                            data-next="2"
                            class="mt-4 px-6 py-2 bg-teal-600 text-white rounded-md font-medium hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Hurrengo atala
                        </button>
                    </div>
                </section>

                <!-- Section 2: Group Dynamics -->
                <section id="section-2" class="hidden">
                    <h2
                        class="text-xl font-semibold mb-6 flex items-center gap-2"
                    >
                        <span
                            class="w-8 h-8 rounded-full bg-teal-600 text-white flex items-center justify-center text-sm"
                            >2</span
                        >
                        Talde-dinamikak
                    </h2>
                    <p
                        id="section-description-2"
                        class="bg-teal-50/80 border border-teal-200/60 p-5 rounded-xl text-teal-700 text-sm mb-6 leading-relaxed whitespace-pre-line transition-opacity duration-300"
                    >
                    </p>
                    <GroupDynamics client:load options={allStudents} />
                    <div class="flex justify-between mt-8">
                        <button
                            type="button"
                            data-prev="1"
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors"
                        >
                            Atzera
                        </button>
                        <button
                            type="button"
                            data-next="3"
                            class="px-6 py-2 bg-teal-600 text-white rounded-md font-medium hover:bg-teal-700 transition-colors"
                        >
                            Hurrengo atala
                        </button>
                    </div>
                </section>

                <!-- Section 3: Professional Skills -->
                <section id="section-3" class="hidden">
                    <h2
                        class="text-xl font-semibold mb-6 flex items-center gap-2"
                    >
                        <span
                            class="w-8 h-8 rounded-full bg-teal-600 text-white flex items-center justify-center text-sm"
                            >3</span
                        >
                        Gaitasun Profesionalak
                    </h2>
                    <p
                        id="section-description-3"
                        class="bg-teal-50/80 border border-teal-200/60 p-5 rounded-xl text-teal-700 text-sm mb-6 leading-relaxed whitespace-pre-line transition-opacity duration-300"
                    >
                    </p>

                    <div class="space-y-8">
                        <div>
                            <h3
                                class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2"
                            >
                                Narratiba Blokea
                            </h3>
                            <SkillSlider
                                client:load
                                label="Sormena"
                                name="narrative_creativity"
                                description="Ideia originalak eta narrazio-kontzeptuak sortzeko gaitasuna."
                            />
                            <SkillSlider
                                client:load
                                label="Idazketa"
                                name="narrative_writing"
                                description="Gidoiak, deskribapenak eta egiturazko dokumentuak idaztea."
                            />
                            <SkillSlider
                                client:load
                                label="Erreferentziak"
                                name="narrative_references"
                                description="Dauden obren eta testuinguru kulturalaren ezagutza."
                            />
                            <SkillSlider
                                client:load
                                label="Komunikazioa"
                                name="narrative_communication"
                                description="Ideiak taldeari argi adieraztea."
                            />
                        </div>

                        <div>
                            <h3
                                class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2"
                            >
                                Teknika Blokea
                            </h3>
                            <SkillSlider
                                client:load
                                label="Kamera"
                                name="technical_camera"
                            />
                            <SkillSlider
                                client:load
                                label="Soinua"
                                name="technical_sound"
                            />
                            <SkillSlider
                                client:load
                                label="Edizioa"
                                name="technical_editing"
                            />
                        </div>

                        <div>
                            <h3
                                class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2"
                            >
                                Kudeaketa Blokea
                            </h3>
                            <SkillSlider
                                client:load
                                label="Plangintza"
                                name="management_planning"
                            />
                            <SkillSlider
                                client:load
                                label="Ekoizpena"
                                name="management_production"
                            />
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button
                            type="button"
                            data-prev="2"
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors"
                        >
                            Atzera
                        </button>
                        <button
                            type="button"
                            data-next="4"
                            class="px-6 py-2 bg-teal-600 text-white rounded-md font-medium hover:bg-teal-700 transition-colors"
                        >
                            Hurrengo atala
                        </button>
                    </div>
                </section>

                <!-- Section 4: Personal Skills -->
                <section id="section-4" class="hidden">
                    <h2
                        class="text-xl font-semibold mb-6 flex items-center gap-2"
                    >
                        <span
                            class="w-8 h-8 rounded-full bg-teal-600 text-white flex items-center justify-center text-sm"
                            >4</span
                        >
                        Gaitasun Pertsonalak
                    </h2>
                    <p
                        id="section-description-4"
                        class="bg-teal-50/80 border border-teal-200/60 p-5 rounded-xl text-teal-700 text-sm mb-6 leading-relaxed whitespace-pre-line transition-opacity duration-300"
                    >
                    </p>

                    <SkillSlider
                        client:load
                        label="Lidergoa"
                        name="soft_leadership"
                    />
                    <SkillSlider
                        client:load
                        label="Entzumena"
                        name="soft_listening"
                    />
                    <SkillSlider
                        client:load
                        label="Ekimen-gaitasuna"
                        name="soft_proactivity"
                    />
                    <SkillSlider
                        client:load
                        label="Talde-lana"
                        name="soft_teamwork"
                    />
                    <SkillSlider
                        client:load
                        label="Motibazioa"
                        name="soft_motivation"
                    />
                    <SkillSlider
                        client:load
                        label="Gatazken konponbidea"
                        name="soft_conflict"
                    />

                    <div class="mt-8 border-t pt-8">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input
                                type="checkbox"
                                required
                                class="mt-1 w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"
                            />
                            <span class="text-sm text-gray-600">
                                <strong>Baldintzak eta baldintzak</strong> onartzen
                                ditut eta emandako informazioa zuzena dela eta taldeak
                                osatzeko erabiliko dela berresten dut.
                            </span>
                        </label>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button
                            type="button"
                            data-prev="3"
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors"
                        >
                            Atzera
                        </button>
                        <button
                            type="submit"
                            class="px-8 py-3 bg-teal-600 text-white rounded-md font-bold hover:bg-teal-700 transition-all shadow-lg hover:shadow-xl active:scale-95"
                        >
                            Inkesta Bidali
                        </button>
                    </div>
                </section>
            </form>
        </div>
    </main>

    <script>
        const sections = document.querySelectorAll<HTMLElement>("section");
        const progressBars = document.querySelectorAll<HTMLElement>(
            "#progress-bar > div",
        );

        document.querySelectorAll("[data-next]").forEach((btn) => {
            btn.addEventListener("click", () => {
                const currentId = btn
                    .closest("section")
                    ?.id.replace("section-", "");
                const nextId = btn.getAttribute("data-next");

                // Validation for Section 2 (Group Dynamics)
                if (currentId === "2") {
                    const comfort = (
                        document.getElementsByName(
                            "comfort",
                        )[0] as HTMLInputElement
                    )?.value;
                    const preferWith = (
                        document.getElementsByName(
                            "preferWith",
                        )[0] as HTMLInputElement
                    )?.value;
                    const preferAvoid = (
                        document.getElementsByName(
                            "preferAvoid",
                        )[0] as HTMLInputElement
                    )?.value;

                    const isAllEmpty =
                        comfort === "[]" &&
                        preferWith === "[]" &&
                        preferAvoid === "[]";

                    if (isAllEmpty) {
                        const confirmed = window.confirm(
                            "Seguru zaude ezer aukeratu gabe jarraitu nahi duzula? Horrek zure talde-erabakiak baldintza ditzake.",
                        );
                        if (!confirmed) return;
                    }
                }

                // Validation for Section 3 (Professional Skills)
                if (currentId === "3") {
                    const sliders = document.querySelectorAll<HTMLInputElement>(
                        'input[type="range"]',
                    );
                    let allDefault = true;
                    sliders.forEach((slider) => {
                        if (slider.value !== "5") allDefault = false;
                    });

                    if (allDefault) {
                        const confirmed = window.confirm(
                            "Seguru zaude gaitasunik aldatu gabe jarraitu nahi duzula? Batez besteko maila (5) onartuko da atal guztietan.",
                        );
                        if (!confirmed) return;
                    }
                }

                if (nextId) showSection(nextId);
            });
        });

        document.querySelectorAll("[data-prev]").forEach((btn) => {
            btn.addEventListener("click", () => {
                const prevId = btn.getAttribute("data-prev");
                if (prevId) showSection(prevId);
            });
        });

        const headerContent: Record<string, { description: string }> = {
            "1": {
                description: `Kaixo! TaldeBOT-i zure talde ideala diseinatzen lagunduko dion profila osatzear zaude. Ez dugu zu 'sailkatu' nahi, klaseko puzzleari zer pieza gehitzen dizkiozun ulertu nahi dugu, zure taldea ahalik eta orekatuena, kementsuena eta produktiboena izan dadin. Hori lortzeko, erabateko zintzotasuna eskatzen dizugu: hemen ez dago erantzun zuzenik edo okerrik, beraz, erantzun zintzotasunez dakizunari buruz eta benetan nola sentitzen zaren. Zure gardentasuna funtsezkoa da balio gehien ematen duzun eta lanean hobekien sentitzen zaren tokia esleitu ahal izateko. Eskerrik asko zure denboragatik!`,
            },
            "2": {
                description: `Atal honek zure lan-ingurune ideala diseinatzen laguntzen digu. Jende berriarekin elkarlanean ha zaitezen nahi dugu, baina ziurtatuz beti duzula konfiantzazko 'aingura' bat eta blokeorik gabeko giroa. Zure lehentasunak eta segurtasun-zirkuluak adieraztean, TaldeBOTek harremanak batzen dituen eta proiektuan zentratu zaitezkeen talde bat konfiguratzea ahalbidetzen duzu, taldeko giroa babestuta dagoela jakinda.`,
            },
            "3": {
                description: `Ebaluatu zure gaitasun tekniko eta sortzaileak. Ez dago erantzun zuzenik, zure piezak taldearen puzzlean nola sartzen diren ikusi nahi dugu besterik gabe.

Hemen zure lan-tresnak definitzen ditugu. Kontua ez da denetik jakitea, segurtasun goldena zer eremutan sentitzen duzun identifikatzea baizik, dela kamera maneiatzen, gidoi bat idazten edo azken materiala editatzen. TaldeBOTek informazio hori erabiliko du zure taldean gako pieza bat bera ere falta ez dadin eta zuk dakizun horretan lideratu ahal izan dezazun, besteen talentu profesionalean oinarritzen zaren bitartean.

Izan zintzoa zure egungo mailarekin.

1etik 4ra: Ikasten ari naiz eta laguntza behar dut arlo honetan.
5etik 7ra: Erraztasunez moldatzen naiz eta modu autonomoan lan egin dezaket.
8tik 10era: Domeinu handia dut eta beste batzuk mentorizatu ditzaket.

Gogoratu: Talde perfektua ez da kide guztiak 10 dutenak, arlo bakoitzean aditua den norbait duena baizik.`,
            },
            "4": {
                description: `Azkenik, kontatu iezaguzu zure jarrerari eta soft skillei buruz. Horrek taldeak dinamika orekatua eta motibatzailea duela ziurtatzen lagunduko digu. Hemen taldearen 'motorra' ebaluatzen dugu. Zure jarrera zure teknika bezain garrantzitsua da. Si eres una persona que prefiere escuchar antes que mandar, o si eres quien siempre motiva cuando el ánimo baja, refléjalo aquí. TaldeBOTek zure nortasuna osatuko duten kideak bilatuko ditu, talkarik egon ez dadin eta lan-fluxua konstantea izan dadin, bermatuz atalen batean ahulagoa bazara, taldean beti izango duzula norbait laguntzeko eta balantza orekaritzeko.`,
            },
        };

        // Helper to show sections
        function showSection(id: string) {
            sections.forEach((s) => s.classList.add("hidden"));
            const targetSection = document.getElementById(`section-${id}`);
            if (targetSection) targetSection.classList.remove("hidden");

            // Update Section Description
            const sectionDescription = document.getElementById(
                `section-description-${id}`,
            );
            if (headerContent[id]) {
                if (sectionDescription) sectionDescription.style.opacity = "0";

                setTimeout(() => {
                    if (sectionDescription) {
                        sectionDescription.textContent =
                            headerContent[id].description;
                        sectionDescription.style.opacity = "1";
                    }
                }, 150);
            }

            const idx = parseInt(id) - 1;
            progressBars.forEach((bar, i) => {
                if (i <= idx) {
                    bar.classList.add("bg-teal-600");
                    bar.classList.remove("bg-slate-200");
                } else {
                    bar.classList.remove("bg-teal-600");
                    bar.classList.add("bg-slate-200");
                }
            });

            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        // Section 1 Validation & Modal Logic
        const studentSelect = document.getElementById(
            "studentSelect",
        ) as HTMLSelectElement;
        const emailPrefix = document.getElementById(
            "emailPrefix",
        ) as HTMLInputElement;
        const fullEmail = document.getElementById(
            "fullEmail",
        ) as HTMLInputElement;
        const termsCheckbox = document.getElementById(
            "terms",
        ) as HTMLInputElement;
        const btnNext1 = document.getElementById(
            "btn-next-1",
        ) as HTMLButtonElement;
        const disclaimerModal = document.getElementById(
            "disclaimerModal",
        ) as HTMLElement;
        const openDisclaimer = document.getElementById(
            "openDisclaimer",
        ) as HTMLElement;
        const closeDisclaimer = document.getElementById(
            "closeDisclaimer",
        ) as HTMLElement;

        function validateSection1() {
            const hasName = studentSelect.value !== "";
            const hasEmail = emailPrefix.value.trim().length > 0;
            const hasTerms = termsCheckbox.checked;

            btnNext1.disabled = !(hasName && hasEmail && hasTerms);
            fullEmail.value =
                emailPrefix.value.trim() + "@alumni.mondragon.edu";

            // Dispatch event for other components to know who "self" is
            if (hasName) {
                window.dispatchEvent(
                    new CustomEvent("student-selected", {
                        detail: { studentId: parseInt(studentSelect.value) },
                    }),
                );
            }
        }

        studentSelect?.addEventListener("change", validateSection1);
        emailPrefix?.addEventListener("input", validateSection1);
        termsCheckbox?.addEventListener("change", validateSection1);

        openDisclaimer?.addEventListener("click", () => {
            disclaimerModal.classList.remove("hidden");
        });

        closeDisclaimer?.addEventListener("click", () => {
            disclaimerModal.classList.add("hidden");
        });

        // Close modal on outside click
        disclaimerModal?.addEventListener("click", (e) => {
            if (
                e.target === disclaimerModal ||
                (e.target as HTMLElement).classList.contains("bg-black/50")
            ) {
                disclaimerModal.classList.add("hidden");
            }
        });

        // Initialize validation and first section
        validateSection1();
        showSection("1");
    </script>
</Layout>
