---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import { db } from "../../lib/db";
import { users } from "../../../db/schema";
import { verifyPassword } from "../../lib/auth";
import { eq } from "drizzle-orm";

let error = "";

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const username = formData.get("username")?.toString() || "";
        const password = formData.get("password")?.toString() || "";

        const user = await db.query.users.findFirst({
            where: eq(users.username, username),
        });

        if (user && await verifyPassword(password, user.hashedPassword)) {
            Astro.cookies.set("admin_session", "active", { path: "/" });
            Astro.cookies.set("admin_user", user.username, { path: "/" });
            return Astro.redirect("/admin/dashboard");
        } else {
            error = "Erabiltzaile edo pasahitz okerra";
        }
    } catch (e) {
        error = "Errorea datuak bidaltzean. Saiatu berriro.";
        console.error("Form parsing error:", e);
    }
}
---

<Layout title="Admin saioa hasi">
    <main class="min-h-screen flex items-center justify-center bg-slate-50 p-4">
        <div
            class="max-w-md w-full bg-white rounded-3xl shadow-2xl shadow-slate-200/50 p-10 border border-slate-200/60"
        >
            <div class="text-center mb-10">
                <div
                    class="w-20 h-20 bg-teal-600 rounded-2xl flex items-center justify-center text-white font-black text-3xl mx-auto mb-6 shadow-xl shadow-teal-600/20"
                >
                    T
                </div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">Admin Sarbidea</h1>
                <p class="text-sm text-slate-400 font-medium mt-2">
                    Sartu zure administratzaile kredentzialak
                </p>
            </div>

            <form method="POST" class="space-y-6">
                <div>
                    <label
                        for="username"
                        class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                        >Erabiltzailea</label
                    >
                    <input
                        type="text"
                        name="username"
                        id="username"
                        required
                        class="block w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-base font-medium"
                        autofocus
                    />
                </div>

                <div>
                    <label
                        for="password"
                        class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                        >Pasahitza</label
                    >
                    <input
                        type="password"
                        name="password"
                        id="password"
                        required
                        class="block w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-base font-medium"
                    />
                </div>

                {
                    error && (
                        <div class="bg-red-50 text-red-600 p-4 rounded-xl text-xs font-bold border border-red-100">
                            {error}
                        </div>
                    )
                }

                <button
                    type="submit"
                    class="w-full py-4 px-6 bg-teal-600 text-white rounded-2xl font-bold hover:bg-teal-700 transition-all shadow-lg shadow-teal-600/30 active:scale-95 text-sm uppercase tracking-widest"
                >
                    Sartu
                </button>
            </form>

            <div class="mt-10 text-center pt-8 border-t border-slate-50">
                <a
                    href="/"
                    class="text-xs font-bold text-slate-400 hover:text-teal-600 uppercase tracking-widest transition-colors"
                    >Bueltatu hasierara</a
                >
            </div>
        </div>
    </main>
</Layout>
