---
export const prerender = false;
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Proiektua Sortu">
    <div class="max-w-4xl mx-auto">
        <div class="md:flex md:items-center md:justify-between mb-10">
            <div class="flex-1 min-w-0">
                <h2
                    class="text-3xl font-black text-slate-900 tracking-tight"
                >
                    Proiektu Berria Konfiguratu
                </h2>
                <p class="mt-2 text-slate-500 font-medium">Zehaztu taldeak osatzeko oinarrizko parametroak.</p>
            </div>
        </div>

        <form
            id="create-project-form"
            action="/api/admin/create-project"
            method="POST"
            class="space-y-0 bg-white shadow-2xl shadow-slate-200/50 rounded-3xl border border-slate-200/60 overflow-hidden"
        >
            <div class="p-8 space-y-10">
                <!-- Project Details -->
                <div class="grid grid-cols-1 gap-y-6 gap-x-6 sm:grid-cols-6 mb-10">
                    <div class="sm:col-span-3">
                        <label
                            for="name"
                            class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                            >Proiektuaren Izena</label
                        >
                        <input
                            type="text"
                            name="name"
                            id="name"
                            required
                            placeholder="Ej. Proyecto Final 2024"
                            class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-sm"
                        />
                    </div>

                    <div class="sm:col-span-3">
                        <label
                            for="adminEmail"
                            class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                            >Administratzailearen Emaila</label
                        >
                        <input
                            type="email"
                            name="adminEmail"
                            id="adminEmail"
                            required
                            placeholder="admin@ejemplo.com"
                            class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-sm"
                        />
                    </div>
                </div>

                <!-- Student Roster -->
                <div class="border-t border-slate-100 pt-8">
                    <h3
                        class="text-lg font-bold text-slate-900 mb-6"
                    >
                        Ikasleen Zerrenda
                    </h3>

                    <div class="space-y-6">
                        <div class="flex gap-6 mb-6 border-b border-slate-100">
                            <button
                                type="button"
                                id="tab-manual"
                                class="pb-3 px-2 text-sm font-bold border-b-2 border-teal-600 text-teal-600 transition-all"
                                >Eskuz sartu</button
                            >
                            <button
                                type="button"
                                id="tab-csv"
                                class="pb-3 px-2 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all"
                                >CSV igo</button
                            >
                        </div>

                        <div id="manual-entry-container">
                            <label
                                for="studentList"
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3"
                                >Ikasleen izenak (bat lerro bakoitzeko)</label
                            >
                            <textarea
                                id="studentList"
                                name="studentList"
                                rows={8}
                                class="block w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-sm font-mono leading-relaxed"
                                placeholder="Juan Pérez
María García
..."></textarea>
                            <p class="mt-3 text-xs text-slate-400 font-medium">
                                Posta elektronikoak geroago editatu daitezke monitorizazio panelean.
                            </p>
                        </div>

                        <div id="csv-upload-container" class="hidden">
                            <div
                                class="flex items-center justify-center p-10 border-2 border-slate-200 border-dashed rounded-2xl bg-slate-50/50 hover:bg-slate-50 hover:border-teal-300 transition-all group cursor-pointer"
                            >
                                <div class="space-y-2 text-center">
                                    <svg
                                        class="mx-auto h-12 w-12 text-slate-300 group-hover:text-teal-400 transition-colors"
                                        stroke="currentColor"
                                        fill="none"
                                        viewBox="0 0 48 48"
                                        aria-hidden="true"
                                    >
                                        <path
                                            d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"></path>
                                    </svg>
                                    <div class="flex text-sm text-slate-600">
                                        <label
                                            for="csv-file"
                                            class="relative cursor-pointer font-bold text-teal-600 hover:text-teal-700"
                                        >
                                            <span>Igo CSV fitxategia</span>
                                            <input
                                                id="csv-file"
                                                type="file"
                                                accept=".csv"
                                                class="sr-only"
                                            />
                                        </label>
                                    </div>
                                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">
                                        Formatua: izena, emaila
                                    </p>
                                </div>
                            </div>
                            <div id="csv-preview" class="mt-4 hidden">
                                <h4
                                    class="text-sm font-medium text-gray-700 mb-2"
                                >
                                    CSV Data Preview (<span id="csv-count"
                                        >0</span
                                    > students found)
                                </h4>
                                <div
                                    class="max-h-40 overflow-y-auto border border-gray-200 rounded text-xs"
                                >
                                    <table
                                        class="min-w-full divide-y divide-gray-200"
                                    >
                                        <tbody
                                            id="csv-preview-body"
                                            class="bg-white divide-y divide-gray-200"
                                        ></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {/* Hidden field for JSON student data from CSV */}
                        <input
                            type="hidden"
                            name="studentsJson"
                            id="studentsJson"
                        />
                    </div>
                </div>

                <!-- Team Configuration -->
                <div class="border-t border-slate-100 pt-8 mt-4">
                    <h3
                        class="text-lg font-bold text-slate-900 mb-6"
                    >
                        Taldeen Konfigurazioa
                    </h3>
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-3" id="numTeamsContainer">
                            <label
                                for="numTeams"
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                                >Talde Kopurua</label
                            >
                            <input
                                type="number"
                                name="numTeams"
                                id="numTeams"
                                min="2"
                                required
                                placeholder="Ej. 5"
                                class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-sm"
                            />
                        </div>

                        <div
                            class="sm:col-span-6 bg-teal-50 border border-teal-100 rounded-2xl p-6"
                            id="distributionPreview"
                        >
                            <div
                                class="flex items-center gap-3 text-teal-700 font-bold text-sm mb-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                    ></path><circle cx="9" cy="7" r="4"
                                    ></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"
                                    ></path><path d="M16 3.13a4 4 0 0 1 0 7.75"
                                    ></path></svg
                                >
                                Banaketaren aurrebista
                            </div>
                            <p class="text-sm text-teal-600/80 font-medium leading-relaxed" id="previewText">
                                Sartu ikasleen zerrenda eta talde kopurua nola banatuko diren ikusteko.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Final Details -->
                <div class="border-t border-slate-100 pt-8">
                    <h3
                        class="text-lg font-bold text-slate-900 mb-6"
                    >
                        Xehetasun gehiago
                    </h3>
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-6">
                            <label
                                for="description"
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2"
                                >Deskribapena</label
                            >
                            <textarea
                                id="description"
                                name="description"
                                rows={3}
                                class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 focus:bg-white transition-all outline-none text-sm leading-relaxed"
                                placeholder="Proiektuaren helburuen deskribapen laburra..."
                            ></textarea>
                        </div>

                        <div class="sm:col-span-6">
                            <span
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3"
                                >Algoritmoaren Irizpidea</span
                            >
                            <div class="flex flex-wrap gap-4">
                                {
                                    [
                                        "balanced",
                                        "technical",
                                        "narrative",
                                        "management",
                                    ].map((type) => (
                                        <label class="relative flex items-center cursor-pointer group">
                                            <input
                                                type="radio"
                                                name="projectType"
                                                value={type}
                                                checked={type === "balanced"}
                                                class="sr-only peer"
                                            />
                                            <div class="px-5 py-2.5 border rounded-full text-xs font-bold uppercase tracking-wider border-slate-200 text-slate-400 peer-checked:bg-teal-600 peer-checked:text-white peer-checked:border-teal-600 peer-checked:shadow-lg peer-checked:shadow-teal-600/30 transition-all active:scale-95 group-hover:border-teal-200">
                                                {type === 'balanced' ? 'Equilibrado' : type === 'technical' ? 'Técnico' : type === 'narrative' ? 'Narrativo' : 'Gestión'}
                                            </div>
                                        </label>
                                    ))
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-8 py-6 bg-slate-50 border-t border-slate-100 flex justify-end">
                <button
                    type="submit"
                    class="inline-flex justify-center px-10 py-4 bg-teal-600 hover:bg-teal-700 text-white font-bold text-sm uppercase tracking-widest rounded-2xl shadow-xl shadow-teal-600/20 transition-all active:scale-95"
                >
                    Proiektua Sortu
                </button>
            </div>
        </form>
    </div>

    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        is:inline></script>
    <script is:inline>
        const tabManual = document.getElementById("tab-manual");
        const tabCsv = document.getElementById("tab-csv");
        const manualContainer = document.getElementById(
            "manual-entry-container",
        );
        const csvContainer = document.getElementById("csv-upload-container");
        const csvFileInput = document.getElementById("csv-file");
        const studentsJsonInput = document.getElementById("studentsJson");
        const csvPreview = document.getElementById("csv-preview");
        const csvPreviewBody = document.getElementById("csv-preview-body");
        const csvCount = document.getElementById("csv-count");
        const numTeamsContainer = document.getElementById("numTeamsContainer");
        const numTeamsInput = document.getElementById("numTeams");

        const studentListInput = document.getElementById("studentList");
        const previewText = document.getElementById("previewText");

        function updatePreview() {
            let studentCount = 0;
            if (!csvContainer.classList.contains("hidden")) {
                const parsed = studentsJsonInput.value
                    ? JSON.parse(studentsJsonInput.value)
                    : [];
                studentCount = parsed.length;
            } else {
                studentCount = studentListInput.value
                    .split("\n")
                    .map((n) => n.trim())
                    .filter((n) => n.length > 0).length;
            }

            if (studentCount === 0) {
                previewText.innerHTML = "Ikasleen zerrendaren zain...";
                return;
            }

            const numTeams = parseInt(numTeamsInput.value);

            if (!numTeams || numTeams < 2) {
                previewText.innerHTML = `<b>${studentCount}</b> ikasle aurkitu dira. Sartu baliozko konfigurazioa.`;
                return;
            }

            const baseSize = Math.floor(studentCount / numTeams);
            const extra = studentCount % numTeams;

            if (baseSize < 1) {
                previewText.innerHTML = `<b>Abisua:</b> Talde gehiegi <b>${studentCount}</b> ikaslerentzat.`;
                return;
            }

            let message = `<b>${studentCount}</b> ikasleren banaketa <b>${numTeams}</b> taldetan:<br/>`;
            if (extra === 0) {
                message += `• Talde guztiek (<b>${numTeams}</b>) <b>${baseSize}</b> kide izango dituzte.`;
            } else {
                message += `• <b>${extra}</b> talde <b>${baseSize + 1}</b> kidekoak.<br/>`;
                message += `• <b>${numTeams - extra}</b> talde <b>${baseSize}</b> kidekoak.`;
            }

            previewText.innerHTML = message;
        }

        numTeamsInput.addEventListener("input", updatePreview);
        studentListInput.addEventListener("input", updatePreview);

        tabManual.addEventListener("click", () => {
            tabManual.className =
                "pb-3 px-2 text-sm font-bold border-b-2 border-teal-600 text-teal-600 transition-all";
            tabCsv.className =
                "pb-3 px-2 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all";
            manualContainer.classList.remove("hidden");
            csvContainer.classList.add("hidden");
            updatePreview();
        });

        tabCsv.addEventListener("click", () => {
            tabCsv.className =
                "pb-3 px-2 text-sm font-bold border-b-2 border-teal-600 text-teal-600 transition-all";
            tabManual.className =
                "pb-3 px-2 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all";
            csvContainer.classList.remove("hidden");
            manualContainer.classList.add("hidden");
            updatePreview();
        });

        csvFileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    const students = results.data
                        .filter((row) => row.name)
                        .map((row) => ({
                            name: row.name,
                            email: row.email || "",
                        }));

                    studentsJsonInput.value = JSON.stringify(students);
                    csvCount.textContent = students.length;

                    csvPreviewBody.innerHTML = "";
                    students.slice(0, 10).forEach((s) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td class="px-3 py-1 font-medium">${s.name}</td><td class="px-3 py-1 text-gray-500">${s.email}</td>`;
                        csvPreviewBody.appendChild(tr);
                    });

                    if (students.length > 10) {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td colspan="2" class="px-3 py-1 text-gray-400 text-center italic">... and ${students.length - 10} more</td>`;
                        csvPreviewBody.appendChild(tr);
                    }

                    csvPreview.classList.remove("hidden");
                    updatePreview();
                },
            });
        });
    </script>
</AdminLayout>
