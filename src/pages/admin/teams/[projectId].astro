---
export const prerender = false;
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { db } from "../../../lib/db";
import { projects, teams } from "../../../../db/schema";
import { eq } from "drizzle-orm";
import TeamCard from "../../../components/TeamCard.astro";

const { projectId } = Astro.params;
const pid = parseInt(projectId || "");

if (isNaN(pid)) return Astro.redirect("/admin/dashboard");

const project = await db.query.projects.findFirst({
    where: eq(projects.id, pid),
});

if (!project) return Astro.redirect("/admin/dashboard");

const projectTeams = await db.query.teams.findMany({
    where: eq(teams.projectId, pid),
    orderBy: (teams, { asc }) => [asc(teams.teamNumber)],
});
---

<AdminLayout title={`Teams: ${project.name}`}>
    <div class="md:flex md:items-center md:justify-between mb-8 print:hidden">
        <div class="flex-1 min-w-0">
            <nav class="flex mb-2" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li>
                        <a
                            href="/admin/dashboard"
                            class="text-sm text-gray-500 hover:text-gray-700"
                            >Projects</a
                        >
                    </li>
                    <li>
                        <svg
                            class="h-5 w-5 text-gray-400"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                            ><path
                                fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"></path></svg
                        >
                    </li>
                    <li class="text-sm font-medium text-gray-700">
                        {project.name}
                    </li>
                </ol>
            </nav>
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl">
                Team Assignments
            </h2>
        </div>
        <div class="mt-4 flex flex-wrap md:mt-0 md:ml-4 gap-3">
            <form
                action={`/api/admin/generate-teams?projectId=${pid}`}
                method="POST"
            >
                <button
                    type="submit"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                    Regenerate
                </button>
            </form>
            <a
                href={`/api/admin/export-teams?projectId=${pid}`}
                class="inline-flex items-center px-4 py-2 border border-blue-600 rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 uppercase tracking-tighter"
            >
                CSV Export
            </a>
            <button
                onclick="window.print()"
                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
                Print View
            </button>
            <form
                action={`/api/admin/send-notifications?projectId=${pid}`}
                method="POST"
            >
                <button
                    type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 uppercase tracking-tighter"
                >
                    Notify Team
                </button>
            </form>
        </div>
    </div>

    <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 print:grid-cols-2 print:gap-4"
    >
        {
            projectTeams.map((team) => (
                <TeamCard
                    teamNumber={team.teamNumber}
                    memberIds={team.memberIds}
                    justification={team.justification}
                />
            ))
        }

        {
            projectTeams.length === 0 && (
                <div class="col-span-full py-20 bg-white rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-12 w-12 text-gray-400 mb-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width={1}
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                        />
                    </svg>
                    <p class="text-gray-500 text-lg">No teams generated yet.</p>
                    <form
                        action={`/api/admin/generate-teams?projectId=${pid}`}
                        method="POST"
                        class="mt-4"
                    >
                        <button
                            type="submit"
                            class="text-blue-600 font-bold hover:underline"
                        >
                            Click here to generate teams now
                        </button>
                    </form>
                </div>
            )
        }
    </div>

    <style>
        @media print {
            body {
                background-color: white !important;
            }
            .bg-gray-50 {
                background-color: white !important;
                border-bottom: 1px solid #eee;
            }
            .shadow {
                box-shadow: none !important;
            }
            .border {
                border: 1px solid #ddd !important;
            }
            .print\:hidden {
                display: none !important;
            }
        }
    </style>
</AdminLayout>
